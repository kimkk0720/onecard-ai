<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÏõêÏπ¥Îìú ÌîÑÎ°ú (ÎîîÏûêÏù∏ ÌîºÎìúÎ∞± Ï†ÅÏö©)</title>
    <style>
        /* Î≥ÄÏàò ÏÑ†Ïñ∏ */
        :root {
            --card-width: 60px;
            --card-height: 90px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2e7d32;
            color: white;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        #game-board {
            flex: 1;
            width: 100%;
            height: 100%;
            position: relative;
            display: grid;
            grid-template-rows: 20% 1fr 140px;
            grid-template-columns: 80px 1fr 80px;
            padding: 5px;
            box-sizing: border-box;
        }

        .player-area {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            position: relative;
            overflow: visible;
        }

        .active-turn {
            background-color: rgba(255, 255, 0, 0.15);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.4);
        }

        #cpu2 { grid-area: 1 / 2 / 2 / 3; }
        #cpu1 { grid-area: 2 / 1 / 3 / 2; }
        #cpu3 { grid-area: 2 / 3 / 3 / 4; }
        #player {
            grid-area: 3 / 1 / 4 / 4;
            justify-content: flex-start;
            padding-top: 10px;
        }

        #center-area {
            grid-area: 2 / 2 / 3 / 3;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 15px;
        }

        #cards-zone {
            display: flex;
            gap: 20px;
            align-items: center;
            position: relative;
        }

        #player-hand {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 110px;
            width: 95%;
            margin-top: 5px;
            perspective: 1000px;
        }

        /* === Ïπ¥Îìú ÎîîÏûêÏù∏ === */
        .card {
            width: var(--card-width);
            height: var(--card-height);
            background-color: white;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.5);
            cursor: pointer;
            position: relative;
            transition: transform 0.2s, margin 0.2s;
            flex-shrink: 0;
            font-family: 'Arial', sans-serif;
        }

        /* Ï¢åÏ∏° ÏÉÅÎã® Ïù∏Îç±Ïä§ */
        .card-corner {
            position: absolute;
            top: 2px;
            left: 2px;
            display: flex;
            flex-direction: column; /* ÏÑ∏Î°ú Î∞∞Ïπò */
            align-items: center;
            line-height: 1;
            font-size: 14px;
            font-weight: bold;
        }

        /* Ï°∞Ïª§Ïö© ÏΩîÎÑà ÌÖçÏä§Ìä∏ (ÏûëÍ≤å) */
        .joker-corner-text {
            font-size: 9px;
            line-height: 0.9;
            margin-top: 1px;
            font-weight: 800;
        }

        /* Ïπ¥Îìú Ï§ëÏïô ÎÇ¥Ïö© */
        .card-center {
            font-size: 24px;
            font-weight: bold;
        }

        .card.red { color: #d32f2f; }
        .card.black { color: #212121; }
        .card.joker-black { color: black; border: 2px solid #555; }
        .card.joker-color { color: red; border: 2px solid #ff9800; }

        .card-back {
            background-color: #1a237e;
            background-image: repeating-linear-gradient(45deg, #1a237e 0, #1a237e 5px, #283593 5px, #283593 10px);
            border: 2px solid #fff;
            color: transparent;
        }

        #player-hand .card:active { transform: translateY(-20px) scale(1.1); z-index: 1000 !important; }

        #draw-penalty-badge {
            position: absolute; top: -15px; right: -15px;
            width: 35px; height: 35px;
            background-color: #d32f2f; color: white;
            border-radius: 50%; border: 3px solid white;
            display: none; justify-content: center; align-items: center;
            font-weight: 900; font-size: 18px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5); z-index: 100;
            animation: popBadge 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popBadge { 0% {transform:scale(0);} 100% {transform:scale(1);} }

        .diagonal-text { transform: rotate(-45deg); font-size: 15px; font-weight: 900; display: block; }

        #current-suit-indicator {
            font-size: 16px; font-weight: bold;
            background: rgba(0,0,0,0.6); padding: 5px 15px;
            border-radius: 20px; color: #fff; min-height: 27px;
            display: flex; align-items: center; gap: 5px;
        }
        .suit-icon { font-size: 20px; }
        .red-suit { color: #ff5252; }
        .black-suit { color: #fff; }
        .any-suit { color: #ffeb3b; text-shadow: 0 0 5px orange; }

        .player-name {
            background: rgba(0,0,0,0.5); padding: 2px 8px;
            border-radius: 10px; margin-bottom: 5px;
            font-size: 12px; font-weight: bold;
        }

        .cpu-hand-visual {
            display: flex; justify-content: center; align-items: center;
            height: 80px; width: 80px;
        }
        .cpu-card {
            width: 30px; height: 45px;
            border-radius: 3px; box-shadow: -1px 0 2px rgba(0,0,0,0.3);
            margin-left: -20px; transition: all 0.3s ease;
        }
        .cpu-card:first-child { margin-left: 0; }

        #cpu1 .cpu-hand-visual, #cpu3 .cpu-hand-visual { flex-direction: column; height: 100%; }
        #cpu1 .cpu-card, #cpu3 .cpu-card {
            margin-left: 0; margin-top: -35px; transform: rotate(90deg);
        }
        #cpu1 .cpu-card:first-child, #cpu3 .cpu-card:first-child { margin-top: 0; }

        #deck { position: relative; overflow: visible; }
        #deck:active { transform: scale(0.95); }

        #confetti-canvas { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:10000; }

        #one-card-btn {
            position: absolute; width: 90px; height: 90px;
            background: radial-gradient(circle, #ffeb3b 0%, #fbc02d 100%);
            color: #d32f2f; font-size: 18px; font-weight: 900;
            border: 4px solid #d32f2f; border-radius: 50%;
            cursor: pointer; z-index: 9999; display: none;
            box-shadow: 0 0 20px #ffeb3b; animation: pulse 0.5s infinite;
            text-align: center; line-height: 82px;
        }
        @keyframes pulse { 0% {transform:scale(1);} 50% {transform:scale(1.1);} 100% {transform:scale(1);} }

        #restart-btn {
            position: absolute; top: 10px; right: 10px;
            padding: 8px 15px; background-color: #0288d1;
            color: white; border: none; border-radius: 5px;
            font-size: 14px; font-weight: bold; z-index: 10001; display: none;
        }

        #game-log {
            position: absolute; bottom: 150px;
            left: 50%; transform: translateX(-50%);
            width: 80%; height: 30px;
            background: rgba(0,0,0,0.7); color: #fff;
            border-radius: 15px; pointer-events: none;
            z-index: 50;
            display: flex; justify-content: center; align-items: center;
            font-size: 13px; padding: 0 10px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        #suit-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 20000;
        }
        .suit-options { display: flex; gap: 15px; margin-top: 20px; }
        .suit-btn {
            width: 60px; height: 60px; font-size: 30px;
            background: white; border: none; border-radius: 10px;
        }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>
<button id="restart-btn" onclick="location.reload()">üîÑ Îã§ÏãúÌïòÍ∏∞</button>

<div id="suit-modal">
    <h2 style="color:white;">Î¨¥Îä¨ ÏÑ†ÌÉù</h2>
    <div class="suit-options">
        <button class="suit-btn" onclick="resolveSuitSelection('‚ô†')" style="color:black">‚ô†</button>
        <button class="suit-btn" onclick="resolveSuitSelection('‚ô¶')" style="color:red">‚ô¶</button>
        <button class="suit-btn" onclick="resolveSuitSelection('‚ô•')" style="color:red">‚ô•</button>
        <button class="suit-btn" onclick="resolveSuitSelection('‚ô£')" style="color:black">‚ô£</button>
    </div>
</div>

<div id="game-board">
    <div id="cpu2" class="player-area">
        <div class="player-name">CPU 2</div>
        <div class="cpu-hand-visual"></div>
    </div>
    <div id="cpu1" class="player-area">
        <div class="player-name">CPU 1</div>
        <div class="cpu-hand-visual"></div>
    </div>

    <div id="center-area">
        <div id="current-suit-indicator"></div>
        <div id="cards-zone">
            <div id="deck" class="card card-back" onclick="playerDraw()">
                Deck
                <div id="draw-penalty-badge">0</div>
            </div>
            <div id="discard-pile" class="card"></div>
        </div>
    </div>

    <div id="cpu3" class="player-area">
        <div class="player-name">CPU 3</div>
        <div class="cpu-hand-visual"></div>
    </div>

    <div id="player" class="player-area">
        <div class="player-name">YOU</div>
        <div id="player-hand"></div>
    </div>
</div>

<div id="one-card-btn">ÏõêÏπ¥Îìú!</div>
<div id="game-log">Í≤åÏûÑ ÏãúÏûë!</div>

<script>
    function setScreenHeight() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        document.body.style.height = (window.innerHeight) + "px";
    }
    window.addEventListener('resize', setScreenHeight);
    setScreenHeight();

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if(type==='play') {
            osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(100, now+0.1);
            gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
            osc.start(now); osc.stop(now+0.1);
        } else if(type==='draw') {
            osc.type='triangle'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(500, now+0.1);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now+0.1);
            osc.start(now); osc.stop(now+0.1);
        } else if(type==='attack') {
            osc.type='sawtooth'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(100, now+0.2);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now+0.2);
            osc.start(now); osc.stop(now+0.2);
        } else if(type==='alert') {
            osc.type='square'; osc.frequency.setValueAtTime(700, now);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
            osc.start(now); osc.stop(now+0.3);
        } else if(type==='special') {
            osc.type='sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now+0.3);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
            osc.start(now); osc.stop(now+0.3);
        }
    }

    function playFanfare() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        [523, 659, 783, 1046].forEach((f,i)=>{
            const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.type='triangle'; o.frequency.value=f;
            g.gain.setValueAtTime(0.2, audioCtx.currentTime + i*0.15);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i*0.15 + 0.5);
            o.start(audioCtx.currentTime + i*0.15); o.stop(audioCtx.currentTime + i*0.15 + 0.5);
        });
    }

    const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
    const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    let deck=[], discardPile=[], players=[], currentPlayerIndex=0, turnDirection=1;
    let isGameRunning=true, isProcessingTurn=false, drawStack=0, currentEffectiveSuit=null;
    let oneCardTimer=null;

    const el = {
        discard: document.getElementById('discard-pile'),
        hand: document.getElementById('player-hand'),
        log: document.getElementById('game-log'),
        badge: document.getElementById('draw-penalty-badge'),
        suitInd: document.getElementById('current-suit-indicator'),
        suitModal: document.getElementById('suit-modal'),
        btnOneCard: document.getElementById('one-card-btn'),
        btnRestart: document.getElementById('restart-btn'),
        cpuVisuals: [null,
            document.querySelector('#cpu1 .cpu-hand-visual'),
            document.querySelector('#cpu2 .cpu-hand-visual'),
            document.querySelector('#cpu3 .cpu-hand-visual')]
    };

    function initGame() {
        players = [
            { id:0, name:"YOU", isCpu:false, hand:[] },
            { id:1, name:"CPU1", isCpu:true, hand:[] },
            { id:2, name:"CPU2", isCpu:true, hand:[] },
            { id:3, name:"CPU3", isCpu:true, hand:[] }
        ];
        createDeck(); shuffleDeck(); dealCards(); updateUI();
        log("ÎÇ¥ Ï∞®Î°ÄÏóê Ïπ¥ÎìúÎ•º ÎÇ¥Í±∞ÎÇò Îç±ÏùÑ ÎàåÎü¨ ÎΩëÏúºÏÑ∏Ïöî.");
        highlightCurrentPlayer();
    }

    function createDeck() {
        deck = [];
        suits.forEach(s => ranks.forEach(r => deck.push({suit:s, rank:r, isJoker:false})));
        deck.push({suit:'Joker', rank:'Black', isJoker:true});
        deck.push({suit:'Joker', rank:'Color', isJoker:true});
    }

    function shuffleDeck() {
        for(let i=deck.length-1; i>0; i--) {
            const j=Math.floor(Math.random()*(i+1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
    }

    function dealCards() {
        for(let i=0; i<5; i++) players.forEach(p => { if(deck.length) p.hand.push(deck.pop()); });
        const first = deck.pop();
        discardPile.push(first);
        currentEffectiveSuit = first.isJoker ? 'ANY' : first.suit;
    }

    function drawCard(player) {
        if(!deck.length) reshuffle();
        let count = drawStack > 0 ? drawStack : 1;
        for(let i=0; i<count; i++) {
            if(deck.length) player.hand.push(deck.pop());
            if(!deck.length) reshuffle();
        }
        playSound('draw');
        if(drawStack>0) {
            log(`${player.name}, ${drawStack}Ïû• Î®πÏùå!`);
            drawStack=0;
        }
        updateUI();
    }

    function reshuffle() {
        if(discardPile.length<=1) return;
        const top = discardPile.pop();
        deck = discardPile;
        discardPile = [top];
        shuffleDeck();
        log("Îç± ÏÖîÌîå");
    }

    function isAttack(c) { return c.isJoker || c.rank==='2' || c.rank==='A'; }
    function getAttackVal(c) {
        if(c.isJoker) return c.rank==='Color'?7:5;
        if(c.rank==='A') return 3;
        if(c.rank==='2') return 2;
        return 0;
    }

    function isValid(c, top) {
        if(drawStack > 0) {
            if(c.isJoker) return true;
            if(isAttack(c)) return (c.rank===top.rank || c.suit===currentEffectiveSuit || currentEffectiveSuit==='ANY');
            return false;
        }
        if(c.isJoker || top.isJoker || currentEffectiveSuit==='ANY') return true;
        return c.rank===top.rank || c.suit===currentEffectiveSuit;
    }

    function checkWin(pid) {
        if(players[pid].hand.length===0) {
            isGameRunning=false;
            el.btnRestart.style.display='block';
            if(pid===0) { playFanfare(); alert("ÏäπÎ¶¨ÌñàÏäµÎãàÎã§!"); }
            else { alert(players[pid].name + " ÏäπÎ¶¨!"); }
            return true;
        }
        return false;
    }

    function nextTurn() {
        if(!isGameRunning) return;
        if(checkWin(currentPlayerIndex)) return;
        currentPlayerIndex = (currentPlayerIndex + turnDirection + 4) % 4;
        updateUI(); highlightCurrentPlayer();

        if(players[currentPlayerIndex].isCpu) {
            isProcessingTurn=true; setTimeout(cpuTurn, 800);
        } else {
            isProcessingTurn=false;
            log(drawStack>0 ? `Î∞©Ïñ¥ÌïòÍ±∞ÎÇò ${drawStack}Ïû• ÎìúÎ°úÏö∞!` : "ÎãπÏã†Ïùò Ï∞®Î°Ä");
        }
    }

    window.playerDraw = function() {
        if(currentPlayerIndex!==0 || isProcessingTurn) return;
        drawCard(players[0]);
        updateUI(); nextTurn();
    };

    function playerPlay(idx) {
        if(currentPlayerIndex!==0 || isProcessingTurn) return;
        const card = players[0].hand[idx];
        const top = discardPile[discardPile.length-1];

        if(isValid(card, top)) {
            isProcessingTurn=true;
            players[0].hand.splice(idx, 1);
            discardPile.push(card);

            if(card.isJoker) currentEffectiveSuit='ANY';
            else if(card.rank!=='7') currentEffectiveSuit=card.suit;

            if(!isAttack(card) && !['K','Q','J','7'].includes(card.rank)) playSound('play');

            updateUI();
            if(checkWin(0)) return;

            checkOneCard(0, () => {
                const res = processEffect(card, 0);
                if(res!=='WAIT_UI' && res!=='REPEAT') nextTurn();
                else if(res==='REPEAT') { isProcessingTurn=false; log("Ìïú Î≤à Îçî!"); updateUI(); }
            });
        } else {
            log("ÎÇº Ïàò ÏóÜÏäµÎãàÎã§.");
        }
    }

    function cpuTurn() {
        if(!isGameRunning) return;
        const cpu = players[currentPlayerIndex];
        const top = discardPile[discardPile.length-1];
        const idx = cpu.hand.findIndex(c => isValid(c, top));

        if(idx !== -1) {
            const card = cpu.hand.splice(idx, 1)[0];
            discardPile.push(card);

            if(card.isJoker) currentEffectiveSuit='ANY';
            else if(card.rank!=='7') currentEffectiveSuit=card.suit;

            if(!isAttack(card) && !['K','Q','J','7'].includes(card.rank)) playSound('play');
            updateUI();

            if(checkWin(currentPlayerIndex)) return;

            checkOneCard(currentPlayerIndex, () => {
                const res = processEffect(card, currentPlayerIndex);
                if(res==='REPEAT') setTimeout(cpuTurn, 800);
                else nextTurn();
            });
        } else {
            drawCard(cpu);
            nextTurn();
        }
    }

    function processEffect(c, pid) {
        if(isAttack(c)) {
            const dmg = getAttackVal(c);
            drawStack += dmg;
            log(`Í≥µÍ≤©! +${dmg} (Ï¥ù ${drawStack})`);
            playSound('attack');
        }
        if(c.rank==='K') { playSound('special'); return 'REPEAT'; }
        if(c.rank==='Q') { playSound('special'); turnDirection *= -1; }
        if(c.rank==='J') { playSound('special'); currentPlayerIndex = (currentPlayerIndex+turnDirection+4)%4; }
        if(c.rank==='7') {
            playSound('special');
            if(players[pid].isCpu) {
                const cnt = {'‚ô†':0, '‚ô•':0, '‚ô¶':0, '‚ô£':0};
                players[pid].hand.forEach(h=> {if(!h.isJoker) cnt[h.suit]++});
                currentEffectiveSuit = Object.keys(cnt).reduce((a,b)=>cnt[a]>cnt[b]?a:b);
                log(`${players[pid].name}: ${currentEffectiveSuit}Î°ú Î≥ÄÍ≤Ω`);
                return 'NEXT';
            } else {
                el.suitModal.style.display='flex';
                return 'WAIT_UI';
            }
        }
        return 'NEXT';
    }

    window.resolveSuitSelection = function(s) {
        el.suitModal.style.display='none';
        currentEffectiveSuit=s;
        log(`${s}Î°ú Î≥ÄÍ≤ΩÎê®`);
        updateUI(); nextTurn();
    };

    function checkOneCard(pid, cb) {
        if(players[pid].hand.length===1) {
            playSound('alert');
            el.btnOneCard.style.display='block';
            el.btnOneCard.style.left = Math.random()*(window.innerWidth-100)+'px';
            el.btnOneCard.style.top = Math.random()*(window.innerHeight-100)+'px';

            let clicked=false;
            el.btnOneCard.onclick = () => {
                clicked=true; el.btnOneCard.style.display='none'; clearTimeout(oneCardTimer);
                if(pid===0) log("Î∞©Ïñ¥ ÏÑ±Í≥µ!");
                else {
                    log("Í≤¨Ï†ú ÏÑ±Í≥µ! (+1)");
                    let temp=drawStack; drawStack=0; drawCard(players[pid]); drawStack=temp;
                }
                cb();
            };
            oneCardTimer = setTimeout(()=>{
                el.btnOneCard.onclick=null;
                if(!clicked) {
                    el.btnOneCard.style.display='none';
                    if(pid===0) {
                        log("ÏõêÏπ¥Îìú Ïã§Ìå® (+1)");
                        let temp=drawStack; drawStack=0; drawCard(players[0]); drawStack=temp;
                    }
                    cb();
                }
            }, 1000);
        } else cb();
    }

    // [ÏàòÏ†ï] Ïπ¥Îìú HTML ÏÉùÏÑ± Î°úÏßÅ
    function createCardHTML(card) {
        if (card.isJoker) {
            // Ï°∞Ïª§: Ï¢åÏ∏° ÏÉÅÎã®Ïóê ÏÑ∏Î°úÎ°ú JOKER ÌëúÏãú
            return `
                <div class="card-corner">
                    <div class="joker-corner-text">J</div>
                    <div class="joker-corner-text">O</div>
                    <div class="joker-corner-text">K</div>
                    <div class="joker-corner-text">E</div>
                    <div class="joker-corner-text">R</div>
                </div>
                <span class="diagonal-text">JOKER</span>
            `;
        }
        // ÏùºÎ∞ò: Ï¢åÏ∏° ÏÉÅÎã® Î¨∏Ïñë -> Ïà´Ïûê ÏàúÏÑú
        return `
            <div class="card-corner">
                <div>${card.rank}</div>
                <div>${card.suit}</div>
            </div>
            <div class="card-center">
                ${card.suit}${card.rank}
            </div>
        `;
    }

    function updateUI() {
        const top = discardPile[discardPile.length-1];
        let cls = `card ${['‚ô•','‚ô¶'].includes(top.suit)||top.rank==='Color'?'red':'black'}`;
        if(top.isJoker) cls = top.rank==='Color'?'card joker-color':'card joker-black';

        el.discard.className = cls;
        el.discard.innerHTML = createCardHTML(top);

        if(drawStack>0) { el.badge.style.display='flex'; el.badge.textContent=drawStack; }
        else el.badge.style.display='none';

        let sIcon = currentEffectiveSuit==='ANY' ?
            `<span class="suit-icon any-suit">ÏûêÏú†</span>` :
            `<span class="suit-icon ${['‚ô•','‚ô¶'].includes(currentEffectiveSuit)?'red-suit':'black-suit'}">${currentEffectiveSuit}</span>`;
        el.suitInd.innerHTML = `ÌòÑÏû¨: ${sIcon}`;

        renderPlayerHand();

        for(let i=1; i<=3; i++) {
            el.cpuVisuals[i].innerHTML='';
            for(let k=0; k<players[i].hand.length; k++) {
                const c = document.createElement('div');
                c.className = 'card card-back cpu-card';
                el.cpuVisuals[i].appendChild(c);
            }
        }
    }

    function renderPlayerHand() {
        el.hand.innerHTML = '';
        const hand = players[0].hand;
        const count = hand.length;

        const cardWidth = 60;
        const containerWidth = el.hand.clientWidth;

        let overlap = -5;
        const totalNeeded = count * cardWidth;

        if (count > 1 && totalNeeded > containerWidth) {
            overlap = (containerWidth - (count * cardWidth)) / (count - 1);
            overlap -= 2;
        }

        hand.forEach((card, i) => {
            const d = document.createElement('div');
            let cClass = `card ${['‚ô•','‚ô¶'].includes(card.suit) ? 'red' : 'black'}`;
            if(card.isJoker) cClass = card.rank==='Color'?'card joker-color':'card joker-black';

            d.className = cClass;
            d.innerHTML = createCardHTML(card);
            d.onclick = () => playerPlay(i);

            if (i < count - 1) {
                d.style.marginRight = `${overlap}px`;
            }
            d.style.zIndex = i;

            el.hand.appendChild(d);
        });
    }

    function highlightCurrentPlayer() {
        document.querySelectorAll('.player-area').forEach(e => e.classList.remove('active-turn'));
        ['player','cpu1','cpu2','cpu3'].forEach((id, i) => {
            if(i===currentPlayerIndex) document.getElementById(id).classList.add('active-turn');
        });
    }

    function log(msg) { el.log.textContent = msg; }

    initGame();
</script>
</body>
</html>