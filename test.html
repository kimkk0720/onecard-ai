<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì›ì¹´ë“œ í”„ë¡œ (ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ ê³ ì •)</title>
    <style>
        /* ë³€ìˆ˜ ì„ ì–¸ */
        :root {
            --card-width: 60px;
            --card-height: 90px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2e7d32;
            color: white;
            margin: 0;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ì ˆëŒ€ ë°©ì§€ */
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh; /* ëª¨ë°”ì¼ ì£¼ì†Œì°½ ëŒ€ì‘ */
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        #game-board {
            flex: 1;
            width: 100%;
            height: 100%;
            position: relative;
            display: grid;
            /* í–‰ ë†’ì´ ê³ ì •: ìƒë‹¨(20%) ì¤‘ì•™(ë‚˜ë¨¸ì§€) í•˜ë‹¨(140px ê³ ì •) */
            grid-template-rows: 20% 1fr 140px;
            grid-template-columns: 80px 1fr 80px; /* ì¢Œìš° CPU ì˜ì—­ ê³ ì • */
            padding: 5px;
            box-sizing: border-box;
        }

        .player-area {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            position: relative;
            overflow: visible; /* ì¹´ë“œê°€ ì‚´ì§ íŠ€ì–´ë‚˜ì™€ë„ ë³´ì´ê²Œ */
        }

        .active-turn {
            background-color: rgba(255, 255, 0, 0.15);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.4);
        }

        /* ê·¸ë¦¬ë“œ ì˜ì—­ í• ë‹¹ */
        #cpu2 { grid-area: 1 / 2 / 2 / 3; } /* ìƒë‹¨ */
        #cpu1 { grid-area: 2 / 1 / 3 / 2; } /* ì¢Œì¸¡ */
        #cpu3 { grid-area: 2 / 3 / 3 / 4; } /* ìš°ì¸¡ */
        #player {
            grid-area: 3 / 1 / 4 / 4; /* í•˜ë‹¨ ì „ì²´ ì‚¬ìš© */
            justify-content: flex-start; /* ìœ„ìª½ ì •ë ¬ */
            padding-top: 10px;
        }

        #center-area {
            grid-area: 2 / 2 / 3 / 3;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 15px;
        }

        #cards-zone {
            display: flex;
            gap: 20px;
            align-items: center;
            position: relative;
        }

        /* í”Œë ˆì´ì–´ ì†íŒ¨ ì˜ì—­ (ê°€ì¥ ì¤‘ìš”: ë†’ì´ ê³ ì •) */
        #player-hand {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 110px; /* ì¹´ë“œ(90) + í˜¸ë²„ê³µê°„(20) */
            width: 95%;    /* í™”ë©´ ê½‰ ì°¨ê²Œ */
            margin-top: 5px;
            perspective: 1000px;
        }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card {
            width: var(--card-width);
            height: var(--card-height);
            background-color: white;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            font-weight: bold;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.5);
            cursor: pointer;
            position: relative;
            transition: transform 0.2s, margin 0.2s; /* ë¶€ë“œëŸ¬ìš´ ì›€ì§ì„ */
            flex-shrink: 0; /* ê³µê°„ ì¢ì•„ë„ ì¹´ë“œ í¬ê¸° ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
        }

        .card.red { color: #d32f2f; }
        .card.black { color: #212121; }
        .card.joker-black { color: black; border: 2px solid #555; }
        .card.joker-color { color: red; border: 2px solid #ff9800; }

        .card-back {
            background-color: #1a237e;
            background-image: repeating-linear-gradient(45deg, #1a237e 0, #1a237e 5px, #283593 5px, #283593 10px);
            border: 2px solid #fff;
            color: transparent;
        }

        /* ë‚´ ì¹´ë“œëŠ” í˜¸ë²„ ì‹œ ìœ„ë¡œ ì˜¬ë¼ì˜´ */
        #player-hand .card:active { transform: translateY(-15px) scale(1.1); z-index: 100 !important; }

        /* ê¸°íƒ€ UI ìš”ì†Œë“¤ */
        #draw-penalty-badge {
            position: absolute; top: -15px; right: -15px;
            width: 35px; height: 35px;
            background-color: #d32f2f; color: white;
            border-radius: 50%; border: 3px solid white;
            display: none; justify-content: center; align-items: center;
            font-weight: 900; font-size: 18px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5); z-index: 100;
            animation: popBadge 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popBadge { 0% {transform:scale(0);} 100% {transform:scale(1);} }

        .diagonal-text { transform: rotate(-45deg); font-size: 15px; font-weight: 900; }

        #current-suit-indicator {
            font-size: 16px; font-weight: bold;
            background: rgba(0,0,0,0.6); padding: 5px 15px;
            border-radius: 20px; color: #fff; min-height: 27px;
            display: flex; align-items: center; gap: 5px;
        }
        .suit-icon { font-size: 20px; }
        .red-suit { color: #ff5252; }
        .black-suit { color: #fff; }
        .any-suit { color: #ffeb3b; text-shadow: 0 0 5px orange; }

        .player-name {
            background: rgba(0,0,0,0.5); padding: 2px 8px;
            border-radius: 10px; margin-bottom: 5px;
            font-size: 12px; font-weight: bold;
        }

        /* CPU ì†íŒ¨ */
        .cpu-hand-visual {
            display: flex; justify-content: center; align-items: center;
            height: 80px; width: 80px;
        }
        .cpu-card {
            width: 30px; height: 45px; /* CPU ì¹´ë“œëŠ” ì‘ê²Œ */
            border-radius: 3px; box-shadow: -1px 0 2px rgba(0,0,0,0.3);
            margin-left: -20px; transition: all 0.3s ease;
        }
        .cpu-card:first-child { margin-left: 0; }

        /* CPU ì¢Œìš°ëŠ” ì„¸ë¡œë¡œ */
        #cpu1 .cpu-hand-visual, #cpu3 .cpu-hand-visual { flex-direction: column; height: 100%; }
        #cpu1 .cpu-card, #cpu3 .cpu-card {
            margin-left: 0; margin-top: -35px; transform: rotate(90deg);
        }
        #cpu1 .cpu-card:first-child, #cpu3 .cpu-card:first-child { margin-top: 0; }

        /* ë± í´ë¦­ */
        #deck { position: relative; overflow: visible; }
        #deck:active { transform: scale(0.95); }

        /* ë²„íŠ¼ ë° ìº”ë²„ìŠ¤ */
        #confetti-canvas { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:10000; }

        #one-card-btn {
            position: absolute; width: 90px; height: 90px;
            background: radial-gradient(circle, #ffeb3b 0%, #fbc02d 100%);
            color: #d32f2f; font-size: 18px; font-weight: 900;
            border: 4px solid #d32f2f; border-radius: 50%;
            cursor: pointer; z-index: 9999; display: none;
            box-shadow: 0 0 20px #ffeb3b; animation: pulse 0.5s infinite;
            text-align: center; line-height: 82px;
        }
        @keyframes pulse { 0% {transform:scale(1);} 50% {transform:scale(1.1);} 100% {transform:scale(1);} }

        #restart-btn {
            position: absolute; top: 10px; right: 10px;
            padding: 8px 15px; background-color: #0288d1;
            color: white; border: none; border-radius: 5px;
            font-size: 14px; font-weight: bold; z-index: 10001; display: none;
        }

        #game-log {
            position: absolute; bottom: 150px; /* í•¸ë“œ ë°”ë¡œ ìœ„ */
            left: 50%; transform: translateX(-50%);
            width: 80%; height: 30px;
            background: rgba(0,0,0,0.7); color: #fff;
            border-radius: 15px; pointer-events: none;
            z-index: 50;
            display: flex; justify-content: center; align-items: center;
            font-size: 13px; padding: 0 10px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        #suit-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 20000;
        }
        .suit-options { display: flex; gap: 15px; margin-top: 20px; }
        .suit-btn {
            width: 60px; height: 60px; font-size: 30px;
            background: white; border: none; border-radius: 10px;
        }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>
<button id="restart-btn" onclick="location.reload()">ğŸ”„ ë‹¤ì‹œí•˜ê¸°</button>

<div id="suit-modal">
    <h2 style="color:white;">ë¬´ëŠ¬ ì„ íƒ</h2>
    <div class="suit-options">
        <button class="suit-btn" onclick="resolveSuitSelection('â™ ')" style="color:black">â™ </button>
        <button class="suit-btn" onclick="resolveSuitSelection('â™¦')" style="color:red">â™¦</button>
        <button class="suit-btn" onclick="resolveSuitSelection('â™¥')" style="color:red">â™¥</button>
        <button class="suit-btn" onclick="resolveSuitSelection('â™£')" style="color:black">â™£</button>
    </div>
</div>

<div id="game-board">
    <div id="cpu2" class="player-area">
        <div class="player-name">CPU 2</div>
        <div class="cpu-hand-visual"></div>
    </div>
    <div id="cpu1" class="player-area">
        <div class="player-name">CPU 1</div>
        <div class="cpu-hand-visual"></div>
    </div>

    <div id="center-area">
        <div id="current-suit-indicator"></div>
        <div id="cards-zone">
            <div id="deck" class="card card-back" onclick="playerDraw()">
                Deck
                <div id="draw-penalty-badge">0</div>
            </div>
            <div id="discard-pile" class="card"></div>
        </div>
    </div>

    <div id="cpu3" class="player-area">
        <div class="player-name">CPU 3</div>
        <div class="cpu-hand-visual"></div>
    </div>

    <div id="player" class="player-area">
        <div class="player-name">YOU</div>
        <div id="player-hand"></div>
    </div>
</div>

<div id="one-card-btn">ì›ì¹´ë“œ!</div>
<div id="game-log">ê²Œì„ ì‹œì‘!</div>

<script>
    /* ==============================
       1. í™”ë©´ ë†’ì´ ê³ ì • (ëª¨ë°”ì¼ í•„ìˆ˜)
       ============================== */
    function setScreenHeight() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        document.body.style.height = (window.innerHeight) + "px";
    }
    window.addEventListener('resize', setScreenHeight);
    setScreenHeight();

    /* ==============================
       2. ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ
       ============================== */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if(type==='play') {
            osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(100, now+0.1);
            gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
            osc.start(now); osc.stop(now+0.1);
        } else if(type==='draw') {
            osc.type='triangle'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(500, now+0.1);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now+0.1);
            osc.start(now); osc.stop(now+0.1);
        } else if(type==='attack') {
            osc.type='sawtooth'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(100, now+0.2);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now+0.2);
            osc.start(now); osc.stop(now+0.2);
        } else if(type==='alert') {
            osc.type='square'; osc.frequency.setValueAtTime(700, now);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
            osc.start(now); osc.stop(now+0.3);
        } else if(type==='special') {
            osc.type='sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now+0.3);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
            osc.start(now); osc.stop(now+0.3);
        }
    }

    function playFanfare() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        [523, 659, 783, 1046].forEach((f,i)=>{
            const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.type='triangle'; o.frequency.value=f;
            g.gain.setValueAtTime(0.2, audioCtx.currentTime + i*0.15);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i*0.15 + 0.5);
            o.start(audioCtx.currentTime + i*0.15); o.stop(audioCtx.currentTime + i*0.15 + 0.5);
        });
    }

    /* ==============================
       3. ê²Œì„ ë°ì´í„° ë° ë¡œì§
       ============================== */
    const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
    const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    let deck=[], discardPile=[], players=[], currentPlayerIndex=0, turnDirection=1;
    let isGameRunning=true, isProcessingTurn=false, drawStack=0, currentEffectiveSuit=null;
    let oneCardTimer=null;

    // DOM ìš”ì†Œ
    const el = {
        discard: document.getElementById('discard-pile'),
        hand: document.getElementById('player-hand'),
        log: document.getElementById('game-log'),
        badge: document.getElementById('draw-penalty-badge'),
        suitInd: document.getElementById('current-suit-indicator'),
        suitModal: document.getElementById('suit-modal'),
        btnOneCard: document.getElementById('one-card-btn'),
        btnRestart: document.getElementById('restart-btn'),
        cpuVisuals: [null,
            document.querySelector('#cpu1 .cpu-hand-visual'),
            document.querySelector('#cpu2 .cpu-hand-visual'),
            document.querySelector('#cpu3 .cpu-hand-visual')]
    };

    function initGame() {
        players = [
            { id:0, name:"YOU", isCpu:false, hand:[] },
            { id:1, name:"CPU1", isCpu:true, hand:[] },
            { id:2, name:"CPU2", isCpu:true, hand:[] },
            { id:3, name:"CPU3", isCpu:true, hand:[] }
        ];
        createDeck(); shuffleDeck(); dealCards(); updateUI();
        log("ë‚´ ì°¨ë¡€ì— ì¹´ë“œë¥¼ ë‚´ê±°ë‚˜ ë±ì„ ëˆŒëŸ¬ ë½‘ìœ¼ì„¸ìš”.");
        highlightCurrentPlayer();
    }

    function createDeck() {
        deck = [];
        suits.forEach(s => ranks.forEach(r => deck.push({suit:s, rank:r, isJoker:false})));
        deck.push({suit:'Joker', rank:'Black', isJoker:true});
        deck.push({suit:'Joker', rank:'Color', isJoker:true});
    }

    function shuffleDeck() {
        for(let i=deck.length-1; i>0; i--) {
            const j=Math.floor(Math.random()*(i+1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
    }

    function dealCards() {
        for(let i=0; i<5; i++) players.forEach(p => { if(deck.length) p.hand.push(deck.pop()); });
        const first = deck.pop();
        discardPile.push(first);
        currentEffectiveSuit = first.isJoker ? 'ANY' : first.suit;
    }

    function drawCard(player) {
        if(!deck.length) reshuffle();
        let count = drawStack > 0 ? drawStack : 1;
        for(let i=0; i<count; i++) {
            if(deck.length) player.hand.push(deck.pop());
            if(!deck.length) reshuffle();
        }
        playSound('draw');
        if(drawStack>0) {
            log(`${player.name}, ${drawStack}ì¥ ë¨¹ìŒ!`);
            drawStack=0;
        }
        updateUI();
    }

    function reshuffle() {
        if(discardPile.length<=1) return;
        const top = discardPile.pop();
        deck = discardPile;
        discardPile = [top];
        shuffleDeck();
        log("ë± ì…”í”Œ");
    }

    // --- ê²€ì¦ ë° ì²˜ë¦¬ ---
    function isAttack(c) { return c.isJoker || c.rank==='2' || c.rank==='A'; }
    function getAttackVal(c) {
        if(c.isJoker) return c.rank==='Color'?7:5;
        if(c.rank==='A') return 3;
        if(c.rank==='2') return 2;
        return 0;
    }

    function isValid(c, top) {
        if(drawStack > 0) {
            if(c.isJoker) return true;
            if(isAttack(c)) return (c.rank===top.rank || c.suit===currentEffectiveSuit || currentEffectiveSuit==='ANY');
            return false;
        }
        if(c.isJoker || top.isJoker || currentEffectiveSuit==='ANY') return true;
        return c.rank===top.rank || c.suit===currentEffectiveSuit;
    }

    function checkWin(pid) {
        if(players[pid].hand.length===0) {
            isGameRunning=false;
            el.btnRestart.style.display='block';
            if(pid===0) { playFanfare(); alert("ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!"); }
            else { alert(players[pid].name + " ìŠ¹ë¦¬!"); }
            return true;
        }
        return false;
    }

    function nextTurn() {
        if(!isGameRunning) return;
        if(checkWin(currentPlayerIndex)) return;
        currentPlayerIndex = (currentPlayerIndex + turnDirection + 4) % 4;
        updateUI(); highlightCurrentPlayer();

        if(players[currentPlayerIndex].isCpu) {
            isProcessingTurn=true; setTimeout(cpuTurn, 800);
        } else {
            isProcessingTurn=false;
            log(drawStack>0 ? `ë°©ì–´í•˜ê±°ë‚˜ ${drawStack}ì¥ ë“œë¡œìš°!` : "ë‹¹ì‹ ì˜ ì°¨ë¡€");
        }
    }

    // --- í”Œë ˆì´ì–´ ì•¡ì…˜ ---
    window.playerDraw = function() { // ì „ì—­ ë…¸ì¶œ
        if(currentPlayerIndex!==0 || isProcessingTurn) return;
        drawCard(players[0]);
        updateUI(); nextTurn();
    };

    function playerPlay(idx) {
        if(currentPlayerIndex!==0 || isProcessingTurn) return;
        const card = players[0].hand[idx];
        const top = discardPile[discardPile.length-1];

        if(isValid(card, top)) {
            isProcessingTurn=true;
            players[0].hand.splice(idx, 1);
            discardPile.push(card);

            if(card.isJoker) currentEffectiveSuit='ANY';
            else if(card.rank!=='7') currentEffectiveSuit=card.suit;

            if(!isAttack(card) && !['K','Q','J','7'].includes(card.rank)) playSound('play');

            updateUI();
            if(checkWin(0)) return;

            checkOneCard(0, () => {
                const res = processEffect(card, 0);
                if(res!=='WAIT_UI' && res!=='REPEAT') nextTurn();
                else if(res==='REPEAT') { isProcessingTurn=false; log("í•œ ë²ˆ ë”!"); updateUI(); }
            });
        } else {
            log("ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    // --- CPU ë¡œì§ ---
    function cpuTurn() {
        if(!isGameRunning) return;
        const cpu = players[currentPlayerIndex];
        const top = discardPile[discardPile.length-1];
        const idx = cpu.hand.findIndex(c => isValid(c, top));

        if(idx !== -1) {
            const card = cpu.hand.splice(idx, 1)[0];
            discardPile.push(card);

            if(card.isJoker) currentEffectiveSuit='ANY';
            else if(card.rank!=='7') currentEffectiveSuit=card.suit;

            if(!isAttack(card) && !['K','Q','J','7'].includes(card.rank)) playSound('play');
            updateUI();

            if(checkWin(currentPlayerIndex)) return;

            checkOneCard(currentPlayerIndex, () => {
                const res = processEffect(card, currentPlayerIndex);
                if(res==='REPEAT') setTimeout(cpuTurn, 800);
                else nextTurn();
            });
        } else {
            drawCard(cpu);
            nextTurn();
        }
    }

    // --- íš¨ê³¼ ì²˜ë¦¬ ---
    function processEffect(c, pid) {
        if(isAttack(c)) {
            const dmg = getAttackVal(c);
            drawStack += dmg;
            log(`ê³µê²©! +${dmg} (ì´ ${drawStack})`);
            playSound('attack');
        }
        if(c.rank==='K') { playSound('special'); return 'REPEAT'; }
        if(c.rank==='Q') { playSound('special'); turnDirection *= -1; }
        if(c.rank==='J') { playSound('special'); currentPlayerIndex = (currentPlayerIndex+turnDirection+4)%4; }
        if(c.rank==='7') {
            playSound('special');
            if(players[pid].isCpu) {
                // ë‹¨ìˆœ AI: ì œì¼ ë§ì€ ë¬´ëŠ¬
                const cnt = {'â™ ':0, 'â™¥':0, 'â™¦':0, 'â™£':0};
                players[pid].hand.forEach(h=> {if(!h.isJoker) cnt[h.suit]++});
                currentEffectiveSuit = Object.keys(cnt).reduce((a,b)=>cnt[a]>cnt[b]?a:b);
                log(`${players[pid].name}: ${currentEffectiveSuit}ë¡œ ë³€ê²½`);
                return 'NEXT';
            } else {
                el.suitModal.style.display='flex';
                return 'WAIT_UI';
            }
        }
        return 'NEXT';
    }

    window.resolveSuitSelection = function(s) {
        el.suitModal.style.display='none';
        currentEffectiveSuit=s;
        log(`${s}ë¡œ ë³€ê²½ë¨`);
        updateUI(); nextTurn();
    };

    // --- ì›ì¹´ë“œ ë²„íŠ¼ ---
    function checkOneCard(pid, cb) {
        if(players[pid].hand.length===1) {
            playSound('alert');
            el.btnOneCard.style.display='block';
            el.btnOneCard.style.left = Math.random()*(window.innerWidth-100)+'px';
            el.btnOneCard.style.top = Math.random()*(window.innerHeight-100)+'px';

            let clicked=false;
            el.btnOneCard.onclick = () => {
                clicked=true; el.btnOneCard.style.display='none'; clearTimeout(oneCardTimer);
                if(pid===0) log("ë°©ì–´ ì„±ê³µ!");
                else {
                    log("ê²¬ì œ ì„±ê³µ! (+1)");
                    let temp=drawStack; drawStack=0; drawCard(players[pid]); drawStack=temp;
                }
                cb();
            };
            oneCardTimer = setTimeout(()=>{
                el.btnOneCard.onclick=null;
                if(!clicked) {
                    el.btnOneCard.style.display='none';
                    if(pid===0) {
                        log("ì›ì¹´ë“œ ì‹¤íŒ¨ (+1)");
                        let temp=drawStack; drawStack=0; drawCard(players[0]); drawStack=temp;
                    }
                    cb();
                }
            }, 1000);
        } else cb();
    }

    // --- UI ì—…ë°ì´íŠ¸ (í•µì‹¬: ëª¨ë°”ì¼ ê²¹ì¹¨ ì²˜ë¦¬) ---
    function updateUI() {
        // ì¤‘ì•™
        const top = discardPile[discardPile.length-1];
        let txt = top.isJoker ? `<span class="diagonal-text">JOKER</span>` : `${top.suit}${top.rank}`;
        let cls = `card ${['â™¥','â™¦'].includes(top.suit)||top.rank==='Color'?'red':'black'}`;
        if(top.isJoker) cls = top.rank==='Color'?'card joker-color':'card joker-black';

        el.discard.className = cls; el.discard.innerHTML = txt;

        if(drawStack>0) { el.badge.style.display='flex'; el.badge.textContent=drawStack; }
        else el.badge.style.display='none';

        let sIcon = currentEffectiveSuit==='ANY' ?
            `<span class="suit-icon any-suit">ììœ </span>` :
            `<span class="suit-icon ${['â™¥','â™¦'].includes(currentEffectiveSuit)?'red-suit':'black-suit'}">${currentEffectiveSuit}</span>`;
        el.suitInd.innerHTML = `í˜„ì¬: ${sIcon}`;

        // í”Œë ˆì´ì–´ ì†íŒ¨ (ê²¹ì¹¨ ë¡œì§ ì ìš©)
        renderPlayerHand();

        // CPU
        for(let i=1; i<=3; i++) {
            el.cpuVisuals[i].innerHTML='';
            for(let k=0; k<players[i].hand.length; k++) {
                const c = document.createElement('div');
                c.className = 'card card-back cpu-card';
                el.cpuVisuals[i].appendChild(c);
            }
        }
    }

    // â˜… ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ ê³ ì •ì˜ í•µì‹¬ í•¨ìˆ˜ â˜…
    function renderPlayerHand() {
        el.hand.innerHTML = '';
        const hand = players[0].hand;
        const count = hand.length;

        // í™”ë©´ ë„ˆë¹„ì™€ ì¹´ë“œ í¬ê¸°ë¥¼ ê³ ë ¤í•œ ê²¹ì¹¨ ê³„ì‚°
        const cardWidth = 60;
        const containerWidth = el.hand.clientWidth;

        // ê¸°ë³¸ ê²¹ì¹¨: -5px.
        // ì¹´ë“œê°€ ë§ì•„ì„œ (ì¹´ë“œìˆ˜ * ë„ˆë¹„)ê°€ ì»¨í…Œì´ë„ˆë³´ë‹¤ í¬ë©´ ë” ë§ì´ ê²¹ì¹˜ê²Œ ê³„ì‚°
        let overlap = -5;
        const totalNeeded = count * cardWidth;

        if (count > 1 && totalNeeded > containerWidth) {
            // (ì¹´ë“œê°œìˆ˜ * ë„ˆë¹„) + ((ì¹´ë“œê°œìˆ˜-1) * ê²¹ì¹¨) = ì»¨í…Œì´ë„ˆë„ˆë¹„
            // ê²¹ì¹¨ = (ì»¨í…Œì´ë„ˆë„ˆë¹„ - (ì¹´ë“œê°œìˆ˜ * ë„ˆë¹„)) / (ì¹´ë“œê°œìˆ˜ - 1)
            overlap = (containerWidth - (count * cardWidth)) / (count - 1);
            // ë„ˆë¬´ ê½‰ ë¼ì§€ ì•Šê²Œ ì•½ê°„ ì—¬ìœ (-5px ì¶”ê°€)
            overlap -= 2;
        }

        hand.forEach((card, i) => {
            const d = document.createElement('div');
            let cClass = `card ${['â™¥','â™¦'].includes(card.suit) ? 'red' : 'black'}`;
            let cText = `${card.suit}${card.rank}`;
            if(card.isJoker) {
                cClass = card.rank==='Color'?'card joker-color':'card joker-black';
                cText = `<span class="diagonal-text">JOKER</span>`;
            }

            d.className = cClass;
            d.innerHTML = cText;
            d.onclick = () => playerPlay(i);

            // ë™ì  ë§ˆì§„ ì ìš© (ë§ˆì§€ë§‰ ì¹´ë“œëŠ” ë§ˆì§„ ì—†ìŒ)
            if (i < count - 1) {
                d.style.marginRight = `${overlap}px`;
            }
            // Z-Index: ì˜¤ë¥¸ìª½ ì¹´ë“œê°€ ìœ„ë¡œ ì˜¤ê²Œ (ì„ íƒ í¸ì˜ì„±)
            d.style.zIndex = i;

            el.hand.appendChild(d);
        });
    }

    function highlightCurrentPlayer() {
        document.querySelectorAll('.player-area').forEach(e => e.classList.remove('active-turn'));
        ['player','cpu1','cpu2','cpu3'].forEach((id, i) => {
            if(i===currentPlayerIndex) document.getElementById(id).classList.add('active-turn');
        });
    }

    function log(msg) { el.log.textContent = msg; }

    // ì‹œì‘
    initGame();
</script>
</body>
</html>